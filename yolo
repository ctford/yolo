#!/bin/bash

set -euo pipefail

SCRIPT_NAME="yolo"
CONTAINER_NAME="yolo-coding-env"
IMAGE_NAME="yolo-coding"

usage() {
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Create a secure container environment for development with Claude Code"
    echo ""
    echo "Options:"
    echo "  -h, --help           Show this help message"
    echo "  --build              Build the container image without running it"
    echo "  --no-cache           Clear Docker cache during build (requires --build)"
    echo "  --apt PACKAGES...    Add apt packages (requires --build)"
    echo "  --npm PACKAGES...    Add npm packages (requires --build)"
    echo ""
    echo "Default packages installed:"
    echo "  APT: curl, git, vim, jq, unzip, zip, build-essential, ripgrep, gh"
    echo "  NPM: @anthropic-ai/claude-code"
    echo "  Other: Node.js 20.x"
    echo ""
    echo "Examples:"
    echo "  $SCRIPT_NAME                              # Run existing container (requires prior build)"
    echo "  $SCRIPT_NAME --build                      # Build image with defaults"
    echo "  $SCRIPT_NAME --build --no-cache           # Build with cleared cache"
    echo "  $SCRIPT_NAME --build --apt golang         # Build with golang"
    echo "  $SCRIPT_NAME --build --npm typescript     # Build with TypeScript"
    echo "  $SCRIPT_NAME --build --apt clojure leiningen  # Build with multiple apt packages"
    echo "  $SCRIPT_NAME --build --apt go --npm ts    # Build with both apt and npm packages"
    echo ""
    echo "This script must be run from within a git repository."
    echo "The git repository root will be mounted as /workspace in the container."
    echo ""
    echo "Claude Code Authentication:"
    echo "  Run 'claude' inside the container to authenticate via browser OAuth."
    echo "  Or set ANTHROPIC_API_KEY environment variable before running this script."
    echo ""
    echo "GitHub Authentication:"
    echo "  Your git user.name and user.email are automatically passed from host."
    echo "  Set GH_TOKEN environment variable for GitHub push/pull operations:"
    echo "    export GH_TOKEN=ghp_xxxxxxxxxxxx"
    echo "  Get a token at: https://github.com/settings/tokens"
}

check_requirements() {
    if ! command -v docker &> /dev/null; then
        echo "Error: docker command not found"
        echo "Please install Docker, Colima, Podman, or another Docker-compatible runtime"
        exit 1
    fi

    if ! docker info &> /dev/null; then
        echo "Error: Container runtime is not running"
        echo "Please start your container runtime (Docker Desktop, Colima, etc.) and try again"
        exit 1
    fi

    if ! git rev-parse --git-dir &> /dev/null; then
        echo "Error: This script must be run from within a git repository"
        exit 1
    fi
}

build_image() {
    # Parse arguments - first argument is no_cache flag, then split on "---" separator
    local no_cache="$1"
    shift

    local apt_packages=()
    local npm_packages=()
    local current_array="apt"

    for arg in "$@"; do
        if [[ "$arg" == "---" ]]; then
            current_array="npm"
        elif [[ "$current_array" == "apt" ]]; then
            apt_packages+=("$arg")
        else
            npm_packages+=("$arg")
        fi
    done

    local apt_package_line=""
    local npm_package_line=""

    # Build additional apt package line if packages provided
    if [[ ${#apt_packages[@]} -gt 0 ]]; then
        echo "Installing additional apt packages: ${apt_packages[*]}"
        # Format packages with proper indentation and line continuations
        # shellcheck disable=SC2034  # Used in Dockerfile heredoc below
        apt_package_line=" \\
    $(printf '%s \\\n    ' "${apt_packages[@]}")"
        # Remove trailing backslash and spaces from last package
        apt_package_line="${apt_package_line% \\*}"
    fi

    # Build npm install line if packages provided
    if [[ ${#npm_packages[@]} -gt 0 ]]; then
        echo "Installing additional npm packages: ${npm_packages[*]}"
        # shellcheck disable=SC2034  # Used in Dockerfile heredoc below
        npm_package_line="
RUN npm install -g ${npm_packages[*]}"
    fi

    echo "Building secure coding container image..."

    # Create temporary directory for build context
    local build_dir
    build_dir=$(mktemp -d)

    # Set up cleanup trap
    # shellcheck disable=SC2064
    trap "rm -rf '$build_dir'" EXIT ERR

    # Create Dockerfile in build directory
    cat > "$build_dir/Dockerfile" << EOF
FROM ubuntu:22.04

# Install essential development tools
RUN apt-get update && apt-get install -y \
    curl \
    git \
    vim \
    jq \
    unzip \
    zip \
    build-essential \
    ripgrep${apt_package_line} \
    && rm -rf /var/lib/apt/lists/*

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=\$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt-get update && \
    apt-get install -y gh && \
    rm -rf /var/lib/apt/lists/*

# Install Node.js 20.x (required for Claude Code)
# Download and install official Node.js binaries directly
# Automatically detect architecture (arm64 for Apple Silicon, x64 for Intel)
RUN NODE_VERSION=20.18.1 && \
    ARCH=\$(uname -m) && \
    if [ "\$ARCH" = "aarch64" ]; then NODE_ARCH="arm64"; else NODE_ARCH="x64"; fi && \
    curl -fsSL https://nodejs.org/dist/v\${NODE_VERSION}/node-v\${NODE_VERSION}-linux-\${NODE_ARCH}.tar.xz -o /tmp/node.tar.xz && \
    tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1 && \
    rm /tmp/node.tar.xz && \
    node --version && npm --version

# Install Claude Code globally as root (survives tmpfs mount of /home/coder)
RUN npm install -g @anthropic-ai/claude-code && \
    claude --version
${npm_package_line}
# Create non-root user
RUN useradd -m -s /bin/bash -u 1000 coder
RUN usermod -aG sudo coder
# Restrict sudo to package management only for security
RUN mkdir -p /etc/sudoers.d && \
    echo 'coder ALL=(ALL) NOPASSWD: /usr/bin/apt-get, /usr/bin/apt, /usr/bin/dpkg' > /etc/sudoers.d/coder && \
    chmod 0440 /etc/sudoers.d/coder

# Set up workspace
WORKDIR /workspace
RUN chown coder:coder /workspace

# Switch to non-root user
USER coder

# Create entrypoint script to set up home directory and generate claude-unrestricted
USER root
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Add /usr/games to PATH for tools like cowsay' >> /entrypoint.sh && \
    echo 'export PATH=\$PATH:/usr/games' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Recreate home directory setup (tmpfs overlay clears it)' >> /entrypoint.sh && \
    echo 'mkdir -p ~/.config/claude-code ~/.claude' >> /entrypoint.sh && \
    echo 'echo "export PATH=\$PATH:/usr/games" > ~/.bashrc' >> /entrypoint.sh && \
    echo 'echo "cd /workspace" >> ~/.bashrc' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Configure git identity if provided' >> /entrypoint.sh && \
    echo 'if [[ -n "\${GIT_USER_NAME:-}" ]]; then' >> /entrypoint.sh && \
    echo '    git config --global user.name "\$GIT_USER_NAME"' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo 'if [[ -n "\${GIT_USER_EMAIL:-}" ]]; then' >> /entrypoint.sh && \
    echo '    git config --global user.email "\$GIT_USER_EMAIL"' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Configure GitHub CLI authentication if token provided' >> /entrypoint.sh && \
    echo 'if [[ -n "\${GH_TOKEN:-}" ]]; then' >> /entrypoint.sh && \
    echo '    echo "\$GH_TOKEN" | gh auth login --with-token 2>/dev/null' >> /entrypoint.sh && \
    echo '    git config --global credential.helper "!gh auth git-credential"' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Display YOLO skull banner' >> /entrypoint.sh && \
    echo 'cat << '"'"'BANNER_EOF'"'"'' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '    ðŸ’€ðŸ’€   ðŸ’€ðŸ’€   ðŸ’€ðŸ’€ðŸ’€ðŸ’€   ðŸ’€ðŸ’€        ðŸ’€ðŸ’€ðŸ’€ðŸ’€' >> /entrypoint.sh && \
    echo '     ðŸ’€ðŸ’€ ðŸ’€ðŸ’€   ðŸ’€ðŸ’€  ðŸ’€ðŸ’€  ðŸ’€ðŸ’€       ðŸ’€ðŸ’€  ðŸ’€ðŸ’€' >> /entrypoint.sh && \
    echo '      ðŸ’€ðŸ’€ðŸ’€     ðŸ’€ðŸ’€  ðŸ’€ðŸ’€  ðŸ’€ðŸ’€       ðŸ’€ðŸ’€  ðŸ’€ðŸ’€' >> /entrypoint.sh && \
    echo '       ðŸ’€ðŸ’€      ðŸ’€ðŸ’€  ðŸ’€ðŸ’€  ðŸ’€ðŸ’€       ðŸ’€ðŸ’€  ðŸ’€ðŸ’€' >> /entrypoint.sh && \
    echo '       ðŸ’€ðŸ’€       ðŸ’€ðŸ’€ðŸ’€ðŸ’€   ðŸ’€ðŸ’€ðŸ’€ðŸ’€ðŸ’€  ðŸ’€ðŸ’€ðŸ’€ðŸ’€' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '        Unrestricted AI Coding' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'BANNER_EOF' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Create YOLO statusline with skull emoji' >> /entrypoint.sh && \
    echo 'cat > ~/.claude/statusline.sh << '"'"'STATUSLINE_EOF'"'"'' >> /entrypoint.sh && \
    echo '#!/bin/bash' >> /entrypoint.sh && \
    echo '# YOLO Container Status Line' >> /entrypoint.sh && \
    echo '# Displays skull emoji and container info' >> /entrypoint.sh && \
    echo 'set -euo pipefail' >> /entrypoint.sh && \
    echo 'input=\$(cat)' >> /entrypoint.sh && \
    echo 'MODEL_DISPLAY=\$(echo "\$input" | jq -r '"'"'.model.display_name // "Unknown"'"'"')' >> /entrypoint.sh && \
    echo 'CURRENT_DIR=\$(echo "\$input" | jq -r '"'"'.workspace.current_dir // "/"'"'"')' >> /entrypoint.sh && \
    echo 'DIR_NAME=\$(basename "\$CURRENT_DIR")' >> /entrypoint.sh && \
    echo 'BRANCH=""' >> /entrypoint.sh && \
    echo 'if git rev-parse --git-dir &> /dev/null 2>&1; then' >> /entrypoint.sh && \
    echo '    BRANCH=\$(git branch --show-current 2>/dev/null || echo "")' >> /entrypoint.sh && \
    echo '    if [[ -n "\$BRANCH" ]]; then' >> /entrypoint.sh && \
    echo '        BRANCH=" [\$BRANCH]"' >> /entrypoint.sh && \
    echo '    fi' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo 'echo "ðŸ’€ YOLO | \$MODEL_DISPLAY | \$DIR_NAME\$BRANCH"' >> /entrypoint.sh && \
    echo 'STATUSLINE_EOF' >> /entrypoint.sh && \
    echo 'chmod +x ~/.claude/statusline.sh' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Create heavy metal output style for YOLO branding' >> /entrypoint.sh && \
    echo 'mkdir -p ~/.claude/output-styles' >> /entrypoint.sh && \
    echo 'chmod 755 ~/.claude/output-styles' >> /entrypoint.sh && \
    echo 'cat > ~/.claude/output-styles/metal.md << '"'"'METAL_EOF'"'"'' >> /entrypoint.sh && \
    echo '---' >> /entrypoint.sh && \
    echo 'name: Heavy Metal' >> /entrypoint.sh && \
    echo 'description: ðŸ¤˜ Metal-themed AI assistant for hardcore YOLO coding ðŸ’€' >> /entrypoint.sh && \
    echo 'keep-coding-instructions: true' >> /entrypoint.sh && \
    echo '---' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# ðŸ¤˜ Heavy Metal Coding Mode ðŸ’€' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'You are a metal-themed AI assistant helping with hardcore YOLO coding. Think headbanging programmer.' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '## Metal Styling ðŸŽ¸' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '- Use metal/rock terminology while remaining helpful and competent' >> /entrypoint.sh && \
    echo '- Refer to bugs as "obstacles to shred through" or "noise in the mix"' >> /entrypoint.sh && \
    echo '- Call successful operations "crushing it," "shredding," or "nailing the solo"' >> /entrypoint.sh && \
    echo '- Use phrases like "Rock on! ðŸ¤˜", "That rips!", "Brutal!", "Shredding through this..."' >> /entrypoint.sh && \
    echo '- Occasionally use ðŸ’€, ðŸ¤˜, ðŸŽ¸ emojis but keep them brief and infrequent' >> /entrypoint.sh && \
    echo '- Reference the YOLO philosophy: living on the edge, no regrets, full throttle' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '## Important Guidelines' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '- Stay professional and accurate with technical work' >> /entrypoint.sh && \
    echo '- The metal theme is superficial - do not compromise code quality or security' >> /entrypoint.sh && \
    echo '- Keep responses concise - metal flavor should not make responses verbose' >> /entrypoint.sh && \
    echo '- Use the metal tone sparingly so it remains fun rather than annoying' >> /entrypoint.sh && \
    echo 'METAL_EOF' >> /entrypoint.sh && \
    echo 'chmod 644 ~/.claude/output-styles/metal.md' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Create Claude Code preferences with theme' >> /entrypoint.sh && \
    echo 'cat > ~/.claude.json << '"'"'PREFS_EOF'"'"'' >> /entrypoint.sh && \
    echo '{' >> /entrypoint.sh && \
    echo '  "theme": "dark",' >> /entrypoint.sh && \
    echo '  "hasCompletedOnboarding": true' >> /entrypoint.sh && \
    echo '}' >> /entrypoint.sh && \
    echo 'PREFS_EOF' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Create Claude Code settings with statusline and output style configuration' >> /entrypoint.sh && \
    echo 'cat > ~/.claude/settings.json << '"'"'SETTINGS_EOF'"'"'' >> /entrypoint.sh && \
    echo '{' >> /entrypoint.sh && \
    echo '  "outputStyle": "metal",' >> /entrypoint.sh && \
    echo '  "statusLine": {' >> /entrypoint.sh && \
    echo '    "type": "command",' >> /entrypoint.sh && \
    echo '    "command": "~/.claude/statusline.sh",' >> /entrypoint.sh && \
    echo '    "padding": 0' >> /entrypoint.sh && \
    echo '  }' >> /entrypoint.sh && \
    echo '}' >> /entrypoint.sh && \
    echo 'SETTINGS_EOF' >> /entrypoint.sh && \
    echo 'chmod 644 ~/.claude/settings.json' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Run Claude Code by default, or execute provided command' >> /entrypoint.sh && \
    echo 'if [ \$# -eq 0 ]; then' >> /entrypoint.sh && \
    echo '    exec claude-unrestricted' >> /entrypoint.sh && \
    echo 'else' >> /entrypoint.sh && \
    echo '    exec "\$@"' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Create claude-unrestricted command in /usr/local/bin (outside workspace)
RUN echo '#!/bin/bash' > /usr/local/bin/claude-unrestricted && \
    echo '# claude-unrestricted - Start Claude Code with all restrictions disabled' >> /usr/local/bin/claude-unrestricted && \
    echo '# WARNING: This bypasses all safety mechanisms. Use only in secure environments.' >> /usr/local/bin/claude-unrestricted && \
    echo '' >> /usr/local/bin/claude-unrestricted && \
    echo 'set -euo pipefail' >> /usr/local/bin/claude-unrestricted && \
    echo '' >> /usr/local/bin/claude-unrestricted && \
    echo '# Check if running inside the container' >> /usr/local/bin/claude-unrestricted && \
    echo 'if [[ "\$(whoami)" != "coder" ]] || [[ ! -d /workspace ]]; then' >> /usr/local/bin/claude-unrestricted && \
    echo '    echo "âŒ Error: This script must be run inside the yolo container"' >> /usr/local/bin/claude-unrestricted && \
    echo '    echo "   Start the container with: ./yolo.sh"' >> /usr/local/bin/claude-unrestricted && \
    echo '    exit 1' >> /usr/local/bin/claude-unrestricted && \
    echo 'fi' >> /usr/local/bin/claude-unrestricted && \
    echo '' >> /usr/local/bin/claude-unrestricted && \
    echo 'echo "âš ï¸  WARNING: Starting Claude Code in unrestricted mode"' >> /usr/local/bin/claude-unrestricted && \
    echo 'echo "   This bypasses all safety mechanisms and permission checks"' >> /usr/local/bin/claude-unrestricted && \
    echo 'echo "   Use only in secure, isolated environments"' >> /usr/local/bin/claude-unrestricted && \
    echo 'echo ""' >> /usr/local/bin/claude-unrestricted && \
    echo '' >> /usr/local/bin/claude-unrestricted && \
    echo '# Check if Claude Code is installed' >> /usr/local/bin/claude-unrestricted && \
    echo 'if ! command -v claude >/dev/null 2>&1; then' >> /usr/local/bin/claude-unrestricted && \
    echo '    echo "âŒ Claude Code is not installed. Please install it first:"' >> /usr/local/bin/claude-unrestricted && \
    echo '    echo "   npm install -g @anthropic-ai/claude-code"' >> /usr/local/bin/claude-unrestricted && \
    echo '    exit 1' >> /usr/local/bin/claude-unrestricted && \
    echo 'fi' >> /usr/local/bin/claude-unrestricted && \
    echo '' >> /usr/local/bin/claude-unrestricted && \
    echo '# Start Claude Code in unrestricted mode (will use browser OAuth if not authenticated)' >> /usr/local/bin/claude-unrestricted && \
    echo 'exec claude \' >> /usr/local/bin/claude-unrestricted && \
    echo '    --dangerously-skip-permissions \' >> /usr/local/bin/claude-unrestricted && \
    echo '    "\$@"' >> /usr/local/bin/claude-unrestricted && \
    chmod +x /usr/local/bin/claude-unrestricted

USER coder
ENTRYPOINT ["/entrypoint.sh"]
EOF

    # Build the image
    local build_args=("-t" "$IMAGE_NAME")
    if [[ "$no_cache" == "true" ]]; then
        echo "Building with --no-cache flag (cleared cache)..."
        build_args+=("--no-cache")
    fi
    build_args+=("$build_dir")

    if docker build "${build_args[@]}"; then
        echo "Container image built successfully"
    else
        echo "Error: Failed to build container image"
        exit 1
    fi

    # Cleanup handled by trap
}

run_container() {
    local git_root
    git_root=$(git rev-parse --show-toplevel)

    echo "Starting secure coding container..."
    echo "Git repository: $git_root"
    echo "Mounted as: /workspace"
    echo ""
    
    # Remove existing container if it exists
    docker rm -f "$CONTAINER_NAME" 2>/dev/null || true

    # Build environment variable arguments
    local env_args=()

    # Pass through TERM for proper terminal emulation (needed for interactive Claude Code)
    # Use xterm-256color if TERM is not set or is basic/dumb
    local term_value="${TERM:-xterm-256color}"
    if [[ "$term_value" == "dumb" ]] || [[ "$term_value" == "unknown" ]]; then
        term_value="xterm-256color"
    fi
    env_args+=(-e "TERM=$term_value")

    if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
        env_args+=(-e ANTHROPIC_API_KEY)
    else
        echo "Note: ANTHROPIC_API_KEY not set. You'll need to authenticate via browser OAuth inside the container."
        echo ""
    fi

    # Pass through git identity from host
    local git_user_name
    local git_user_email
    git_user_name=$(git config user.name 2>/dev/null || echo "")
    git_user_email=$(git config user.email 2>/dev/null || echo "")

    if [[ -n "$git_user_name" ]]; then
        env_args+=(-e "GIT_USER_NAME=$git_user_name")
    fi

    if [[ -n "$git_user_email" ]]; then
        env_args+=(-e "GIT_USER_EMAIL=$git_user_email")
    fi

    # Pass through GitHub token if set
    if [[ -n "${GH_TOKEN:-}" ]]; then
        env_args+=(-e GH_TOKEN)
    fi

    # Run the container with security restrictions
    if ! docker run -it \
        --name "$CONTAINER_NAME" \
        --rm \
        --dns 8.8.8.8 \
        --dns 1.1.1.1 \
        --security-opt no-new-privileges:true \
        --cap-drop=ALL \
        --cap-add=NET_BIND_SERVICE \
        --read-only \
        --tmpfs /tmp:rw,noexec,nosuid,size=1g \
        --tmpfs /var/tmp:rw,noexec,nosuid,size=1g \
        --tmpfs /home/coder:rw,exec,size=2g,uid=1000,gid=1000 \
        --tmpfs /run:rw,nosuid,nodev,size=128m \
        --memory="4g" \
        --memory-swap="4g" \
        --cpus="2.0" \
        --pids-limit=512 \
        --mount type=bind,source="$git_root",target=/workspace \
        --workdir /workspace \
        ${env_args[@]+"${env_args[@]}"} \
        "$IMAGE_NAME"; then
        echo "Error: Failed to start container"
        exit 1
    fi
}

main() {
    local force_build=false
    local build_only=false
    local no_cache=false
    local apt_packages=()
    local npm_packages=()

    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                usage
                exit 0
                ;;
            --build)
                force_build=true
                build_only=true
                shift
                ;;
            --no-cache)
                no_cache=true
                shift
                ;;
            --apt)
                shift
                # Collect apt package names until next flag or end
                while [[ $# -gt 0 ]] && [[ ! "$1" =~ ^- ]]; do
                    # Basic validation to prevent shell injection
                    if [[ "$1" =~ [\;\|\&\$\`] ]]; then
                        echo "Error: Invalid package name '$1' (contains shell metacharacters)"
                        exit 1
                    fi
                    apt_packages+=("$1")
                    shift
                done
                ;;
            --npm)
                shift
                # Collect npm package names until next flag or end
                while [[ $# -gt 0 ]] && [[ ! "$1" =~ ^- ]]; do
                    # Basic validation to prevent shell injection
                    if [[ "$1" =~ [\;\|\&\$\`] ]]; then
                        echo "Error: Invalid package name '$1' (contains shell metacharacters)"
                        exit 1
                    fi
                    npm_packages+=("$1")
                    shift
                done
                ;;
            *)
                echo "Unknown option: $1"
                usage
                exit 1
                ;;
        esac
    done

    check_requirements

    # Validate that --apt or --npm require --build
    if [[ ${#apt_packages[@]} -gt 0 ]] || [[ ${#npm_packages[@]} -gt 0 ]]; then
        if [[ "$force_build" != true ]]; then
            echo "Error: --apt and --npm require --build to be specified"
            echo "Example: $SCRIPT_NAME --build --apt golang --npm typescript"
            exit 1
        fi
    fi

    # Validate that --no-cache requires --build
    if [[ "$no_cache" == true ]] && [[ "$force_build" != true ]]; then
        echo "Error: --no-cache requires --build to be specified"
        echo "Example: $SCRIPT_NAME --build --no-cache"
        exit 1
    fi

    # Build image if --build is specified
    if [[ "$force_build" == true ]]; then
        build_image "$no_cache" ${apt_packages[@]+"${apt_packages[@]}"} "---" ${npm_packages[@]+"${npm_packages[@]}"}
    fi

    # Only run container if not in build-only mode
    if [[ "$build_only" != true ]]; then
        # Check if image exists before trying to run
        if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
            echo "Error: Container image not found. Build it first with: $SCRIPT_NAME --build"
            exit 1
        fi
        run_container
    fi
}

main "$@"